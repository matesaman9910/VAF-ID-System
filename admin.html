<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Admin Panel - VAF ID System</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    input, select { margin-bottom: 8px; display: block; }
    .profile-card { border: 1px solid #aaa; padding: 10px; margin-bottom: 10px; }
  </style>
</head>
<body>
  <h1>Admin Panel</h1>

  <div id="loginDiv">
    <button onclick="login()">Login with Google</button>
  </div>

  <div id="adminDiv" style="display:none;">
    <button onclick="logout()">Logout</button>

    <hr>
    <h2>Create / Update Profile</h2>
    <form id="profileForm" onsubmit="saveProfile(event)">
      <label>ID: <input type="number" id="idInput" required></label>
      <label>Username: <input type="text" id="usernameInput" required></label>
      <label>Real Name: <input type="text" id="realnameInput" required></label>
      <label>Rank: <input type="text" id="rankInput"></label>
      <label>Department: <input type="text" id="departmentInput"></label>
      <label>Access Level: <input type="number" id="accessInput" min="0" max="9"></label>
      <label>Join Date: <input type="date" id="joindateInput"></label>
      <label>Status:
        <select id="statusInput">
          <option>active</option>
          <option>inactive</option>
          <option>wanted</option>
        </select>
      </label>
      <label>Icon URL: <input type="url" id="iconInput"></label>
      <button type="submit">💾 Save Profile</button>
    </form>
    <p id="resultMsg"></p>

    <hr>
    <h2>QR Code Generator</h2>
    <input type="number" id="qrIdInput" placeholder="Enter ID to generate QR">
    <button onclick="generateQRCode()">📷 Generate QR</button>
    <div id="qrcode"></div>
    <button id="downloadBtn" onclick="downloadQR()" style="display:none;">⬇️ Download QR</button>

    <hr>
    <h2>View Profile by ID</h2>
    <input type="number" id="viewIdInput" placeholder="Enter ID to view">
    <button onclick="loadProfile()">🔍 Load Profile</button>
    <div id="viewProfileResult"></div>

    <hr>
    <h2>All Profiles</h2>
    <div id="allProfiles">Loading...</div>
  </div>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <script src="firebase-config.js"></script>

  <script>
    firebase.auth().onAuthStateChanged(user => {
      if (user) {
        document.getElementById('loginDiv').style.display = 'none';
        document.getElementById('adminDiv').style.display = 'block';
        loadAllProfiles();
      } else {
        document.getElementById('loginDiv').style.display = 'block';
        document.getElementById('adminDiv').style.display = 'none';
      }
    });

    function login() {
      const provider = new firebase.auth.GoogleAuthProvider();
      firebase.auth().signInWithPopup(provider).catch(err => alert("Login failed: " + err.message));
    }

    function logout() {
      firebase.auth().signOut();
    }

    function saveProfile(event) {
      event.preventDefault();
      const id = document.getElementById("idInput").value;
      const profile = {
        username: document.getElementById("usernameInput").value,
        realName: document.getElementById("realnameInput").value,
        rank: document.getElementById("rankInput").value,
        department: document.getElementById("departmentInput").value,
        accessLevel: parseInt(document.getElementById("accessInput").value),
        joinDate: document.getElementById("joindateInput").value,
        status: document.getElementById("statusInput").value,
        icon: document.getElementById("iconInput").value || ""
      };

      firebase.database().ref("profiles/" + id).set(profile).then(() => {
        document.getElementById("resultMsg").textContent = "✅ Saved profile " + id;
        document.getElementById("profileForm").reset();
        loadAllProfiles();
      });
    }

    function generateQRCode() {
      const id = document.getElementById("qrIdInput").value;
      if (!id) return alert("Enter ID first.");
      const qrDiv = document.getElementById("qrcode");
      qrDiv.innerHTML = "";
      new QRCode(qrDiv, { text: id, width: 150, height: 150 });
      document.getElementById("downloadBtn").style.display = "inline";
    }

    function downloadQR() {
      const canvas = document.querySelector("#qrcode canvas");
      if (!canvas) return alert("No QR code to download.");
      const link = document.createElement("a");
      link.download = "vaf-qr.png";
      link.href = canvas.toDataURL("image/png");
      link.click();
    }

    function loadProfile() {
      const id = document.getElementById("viewIdInput").value;
      if (!id) return;
      firebase.database().ref("profiles/" + id).once("value").then(snapshot => {
        const data = snapshot.val();
        if (!data) {
          document.getElementById("viewProfileResult").innerHTML = "❌ Not found.";
        } else {
          document.getElementById("viewProfileResult").innerHTML = `
            <strong>ID:</strong> ${id}<br>
            <strong>Username:</strong> ${data.username}<br>
            <strong>Real Name:</strong> ${data.realName}<br>
            <strong>Status:</strong> ${data.status}<br>
            ${data.icon ? `<img src="${data.icon}" width="80">` : ""}
          `;
        }
      });
    }

    function loadAllProfiles() {
      firebase.database().ref("profiles").once("value").then(snapshot => {
        const container = document.getElementById("allProfiles");
        container.innerHTML = "";
        const data = snapshot.val();
        if (!data) return container.textContent = "No profiles.";
        for (const id in data) {
          const prof = data[id];
          const div = document.createElement("div");
          div.className = "profile-card";
          div.innerHTML = `
            <strong>${id}</strong> - ${prof.username}<br>
            <button onclick="viewOne('${id}')">👁️ View</button>
            <button onclick="editOne('${id}')">✏️ Edit</button>
            <button onclick="deleteOne('${id}')">🗑️ Delete</button>
          `;
          container.appendChild(div);
        }
      });
    }

    function viewOne(id) {
      document.getElementById("viewIdInput").value = id;
      loadProfile();
    }

    function editOne(id) {
      firebase.database().ref("profiles/" + id).once("value").then(snapshot => {
        const p = snapshot.val();
        document.getElementById("idInput").value = id;
        document.getElementById("usernameInput").value = p.username;
        document.getElementById("realnameInput").value = p.realName;
        document.getElementById("rankInput").value = p.rank;
        document.getElementById("departmentInput").value = p.department;
        document.getElementById("accessInput").value = p.accessLevel;
        document.getElementById("joindateInput").value = p.joinDate;
        document.getElementById("statusInput").value = p.status;
        document.getElementById("iconInput").value = p.icon;
        window.scrollTo(0, 0);
      });
    }

    function deleteOne(id) {
      if (!confirm("Are you sure you want to delete ID " + id + "?")) return;
      firebase.database().ref("profiles/" + id).remove().then(() => {
        alert("Deleted " + id);
        loadAllProfiles();
      });
    }
  </script>
</body>
</html>
